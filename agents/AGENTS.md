# Effect gRPC Project Rules

## Description
This file defines the core project structure and coding standards for the Effect gRPC project, a TypeScript library that provides gRPC and Protobuf capabilities for the Effect ecosystem.

## File Patterns
# Refined patterns to focus on core TypeScript source and test files
- `packages/*/src/**/*.ts` - source files
- `packages/*/src/**/*.test.ts` - tests
- `packages/*/src/**/*.test-d.ts` - type tests
# Added pattern for Protocol Buffer files
- `packages/*/proto/**/*.proto`
- `packages/*/buf.gen.yaml`

### Project Structure

**Root Directory:**
- The project is a TypeScript monorepo managed with pnpm workspaces.
- Key configuration files at the root include:
  - `package.json`: Defines workspaces and root dependencies. It uses pnpm as a package manager.
  - `tsconfig.base.json`: Base TypeScript configuration inherited by packages.
  - `eslint.config.mjs`: ESLint configuration with Effect-specific rules.
  - `.prettierrc.js`: Prettier code formatting rules.
  - `README.md`: Project overview for gRPC Protobuf capabilities for Effect ecosystem.

**Packages Directory (`packages/`):**
- Contains individual workspaces/packages:
  - `effect-grpc`: Core library package (`@dr_nikson/effect-grpc`)
  - `example`: Example implementation package (`@dr_nikson/effect-grpc-example`)
- Each package typically includes:
  - `package.json`: Package-specific dependencies and scripts. **Note the `name` field here is used for workspace commands.**
  - `tsconfig.json`: Package-specific TypeScript configuration, extending the root `tsconfig.base.json`.
  - `vitest.config.ts`: Configuration for Vitest test runner and TypeScript type checking.
  - `src/`: Source code directory.
    - `index.ts`: Main entry point for public exports.
    - Module files (e.g., `src/client.ts`, `src/server.ts`): Define specific functionalities.
      - Each module typically consists of 3 files (use `client` as an example):
        - Public API: `client.ts`, contains definitions only, all implementation should be placed in separate file
        - Implementation `client.internal.ts`, all exported members should be annotated with `@internal`
        - Test files (e.g., `src/server.test-d.ts`): Type tests colocated with the source files they test.
      - Modules are exported under namespaces from `index.ts` file (e.g., `EffectGrpcServer`, `EffectGrpcClient`)
  - `dist/`: Compiled JavaScript output directory (generated by `tsc`).
  - `bin/`: Binary executables (e.g., `protoc-gen-effect` for protoc plugin)
  - Protocol Buffer specific configuration:
    - `proto/`: Contains Protocol Buffer definition files (`.proto`)
    - `buf.gen.yaml`: Buf configuration for Protocol Buffer code generation

## **IMPORTANT: Development Workflow**

When developing new features or making changes, follow this iterative process:

1. **Implement Changes:** Write or modify the necessary code in the relevant package(s) (e.g., within `packages/effect-grpc/src` or `packages/example/src`).
2. **Generate Protocol Buffers (if needed):** If working with `.proto` files, regenerate the TypeScript bindings:
    ```bash
    # From package directory or use workspace command
    pnpm run generate:proto
    ```

3.  **Compile Package:** Build the specific package you are working on to check for TypeScript errors. Run this command from the **root directory**. Use the package **name** defined in its `package.json`:
    ```bash
    # Example for the 'effect-grpc' package (path: packages/effect-grpc)
    pnpm --filter ./packages/effect-grpc run build
    ```

4.  **Fix Compilation Errors:** If the build fails, address the TypeScript errors reported by the compiler. Repeat steps 1-3 until the package compiles successfully.

5.  **Run Type Tests:** Execute the type tests using Vitest for modules you have modified. Ensure you are using Node.js v22+ as specified in `engines`. Run the test command from the **root directory**:
    ```bash
    # Run type tests for specific package
    pnpm --filter ./packages/effect-grpc run test:types
    ```

6.  **Fix Type Test Errors:** If any type tests fail, debug the issues in your code or types. Repeat the cycle (steps 1-5) until all relevant tests pass and the package builds without errors.

7.  **Check & Fix Code Style:** Run the linters and formatters to ensure code adheres to the project's style guide. Execute these commands from the **root directory**:
    ```bash
    # Run Prettier to automatically format code
    pnpm run codestyle:fix
    # Run ESLint to check for style and potential errors
    pnpm run lint
    ```
    If any linting errors are reported, review them. If code logic was changed during fixes, you might need to repeat steps 2-6 to ensure everything still compiles and passes tests.

8.  **Build Entire Monorepo:** After confirming the individual package is correct and styled properly, compile the entire monorepo to check for cross-package compatibility and integration issues. Run this command from the **root directory**:
    ```bash
    pnpm -r run build # This builds all workspaces
    ```
    If errors occur during the full build, identify the package(s) causing the issues. Return to step 1 for each problematic package, applying the development workflow (steps 1-7) to resolve the errors package by package.

**Only proceed once the individual package builds, its type tests pass, the code style is correct, AND the entire monorepo builds successfully.** This comprehensive process ensures code quality, correctness, and proper integration before finalizing changes.

### Code Style

IMPORTANT: refer to the best practices and coding standards described in @agents/CODING_STANDARDS.md when write code. 

- Use strict TypeScript type checking with Node.js v22+ requirement
- Document all public exports with JSDoc comments: add comprehensive examples of usage when needed 
- Add file name (with path from the repo-root) at the beginning of each file 
- Follow Effect library patterns and conventions
- Use immutable data structures
- Prefer pure functions
- Use Effect's error handling mechanisms

### Testing
- Use Vitest as the test runner (`vitest.config.ts`)
- Implement type testing with `*.test-d.ts` files for type-level assertions
- Test files must be colocated with their corresponding module files within the `src` directory.
- Use Vitest's typecheck-only mode for type testing:
  ```bash
  pnpm run test:types # Uses vitest --typecheck.only
  ```

### gRPC and Protocol Buffer Integration
- Use Connect-RPC (@connectrpc/connect) for gRPC communication
- Use Buf for Protocol Buffer tooling and code generation
- Protocol Buffer files are located in `packages/*/proto/`
- Generated TypeScript bindings should be regenerated using `pnpm run generate:proto`
- Support both client and server implementations using Effect
- Follow Connect-RPC integration patterns
- Use proper error handling for gRPC interactions
- The project provides a protoc plugin (`protoc-gen-effect`) for generating Effect-compatible code

### Package Management
- Use pnpm workspaces for monorepo management
- Package manager is locked to pnpm@10.16.1
- Use catalog: references for shared dependencies
- Workspace references use `workspace:` prefix
- Engine requirement: Node.js >= 22

### Security
- Never commit API keys or sensitive credentials
- Follow secure gRPC practices

### Error Handling
- Use Effect's error handling mechanisms
- Provide meaningful error messages for gRPC failures
- Handle Protocol Buffer serialization/deserialization errors appropriately
- Log errors appropriately

### Dependencies
- Core dependencies include:
  - `@bufbuild/protobuf`: Protocol Buffer runtime
  - `@bufbuild/protoplugin`: Protocol Buffer plugin framework
  - `@connectrpc/connect`: Connect-RPC client/server
  - `@connectrpc/connect-node`: Node.js specific Connect-RPC utilities
- Keep dependencies up to date
- Use specific versions in `package.json`
- Document any dependency-specific configurations
- Follow the project's dependency management strategy (pnpm workspaces with catalog)